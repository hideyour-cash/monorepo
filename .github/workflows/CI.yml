name: CI
env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  VITE_RELAYER: ${{ secrets.VITE_RELAYER }}
  VITE_CONTRACT: 13f7a05920e419a4b8c0hyctest.testnet
  VITE_NEAR_NETWORK: testnet
  VITE_API_GRAPHQL_URL: https://api.thegraph.com/subgraphs/name/veigajoao/test_hyc
  VITE_NEAR_NODE_URL: https://rpc.testnet.near.org
  VITE_GTM_ID: ${{ secrets.VITE_GTM_ID }}
on: pull_request

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check_build_and_tests:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18.12.1
          cache: 'yarn'

      - name: Relayer Tests
        run: yarn contracts relayer:setup

  relayer-deploy:
    needs: check_build_and_tests
    runs-on: ubuntu-latest
    name: Relayer Deploy
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18.12.1
          cache: 'yarn'

      - name: Installing Dependencies
        run: yarn

      - name: Building Relayer
        run: yarn relayer build

      - name: Publish
        uses: cloudflare/wrangler-action@2.0.0
        with:
          apiToken: ztY_5KVqTuVDv2Nnl7Nl9TtpVT-9MToTWeMXa13H
          command: publish --name dev-relayer
          workingDirectory: 'packages/relayer'
          secrets: |
              RELAYER_FEE
              NEAR_NETWORK
              ACCOUNT_ID
              PRIVATE_KEY
              HYC_CONTRACT
              RPC_URL
        env:
          RELAYER_FEE: "0"
          NEAR_NETWORK: "testnet"
          ACCOUNT_ID: $TESTNET_RELAYER_ACCOUNT_ID
          PRIVATE_KEY: $TESTNET_RELAYER_PRIVATE_KEY
          HYC_CONTRACT: $TESTNET_HYC_CONTRACT
          RPC_URL: "https://rpc.testnet.near.org"
